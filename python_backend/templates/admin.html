<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê´€ë¦¬ì í˜ì´ì§€ - ì¼ì • ê´€ë¦¬</title>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; padding: 20px; background-color: #333; color:white; }
        .container { max-width: 1200px; margin: 0 auto; background: #fff; color:#333; padding:20px; border-radius:10px; }
        .admin-header { background: #d32f2f; color: white; padding: 15px; margin: -20px -20px 20px -20px; border-radius: 10px 10px 0 0; display:flex; justify-content: space-between; align-items: center; }
        .region-btn { padding: 10px 20px; border: 1px solid #ccc; background: #eee; cursor: pointer; border-radius: 5px; margin-right: 5px; }
        .region-btn.active { background: #d32f2f; color: white; border-color: #b71c1c; }
        .btn-download { background-color: #2e7d32; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        /* êµìœ¡ ì£¼ì œ ê´€ë¦¬ ìŠ¤íƒ€ì¼ */
        .topic-manager { margin: 20px 0; padding: 15px; background: #f9f9f9; border: 1px solid #eee; border-radius: 5px; display: none; }
        .topic-input-group { display: flex; gap: 5px; margin-bottom: 10px; }
        .topic-list { margin-top: 10px; display: flex; flex-direction: column; gap: 5px; max-width: 400px; }
        .topic-item { 
            background: #e3f2fd; padding: 10px; border-radius: 5px; border: 1px solid #90caf9; 
            display: flex; align-items: center; justify-content: space-between;
            cursor: grab; transition: background 0.2s;
        }
        .topic-item:active { cursor: grabbing; background: #bbdefb; }
        .topic-item.dragging { opacity: 0.5; border: 2px dashed #2196f3; }
        .topic-content { display: flex; align-items: center; gap: 10px; }
        .drag-handle { color: #888; cursor: grab; font-size: 1.2em; }
        .btn-del-topic { cursor: pointer; color: red; font-weight: bold; padding: 0 5px; }

        /* ìˆ˜ì • ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; width: 450px; border-radius: 10px; position: relative; }
        .close { position: absolute; right: 20px; top: 15px; font-size: 28px; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        .form-group select, .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .btn-update { width: 100%; background-color: #2196f3; color: white; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px; }
        .btn-delete { width: 100%; background-color: #f44336; color: white; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px; }
        
        .fc-toolbar-chunk .fc-button { background-color: #37474f; border: none; }
        .fc-toolbar-chunk .fc-button:hover { background-color: #263238; }
        .fc-toolbar-title { margin: 0 15px !important; font-weight: bold; font-size: 1.5em; }
    </style>
</head>
<body>

<div class="container">
    <div class="admin-header">
        <h2 style="margin:0;">ğŸ› ï¸ ê´€ë¦¬ì ëª¨ë“œ</h2>
        <div>
            <span id="current-info">ê¶Œì—­ì„ ì„ íƒí•˜ì„¸ìš”</span>
            <button onclick="location.href='/api/logout'" style="margin-left:10px; padding:5px; font-size:0.8em;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div style="margin-bottom: 20px;" id="region-nav"></div>

    <div id="topicManager" class="topic-manager">
        <h4>ğŸ“š êµìœ¡ ì£¼ì œ ê´€ë¦¬ (ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½ ê°€ëŠ¥)</h4>
        <div class="topic-input-group">
            <input type="text" id="newTopicTitle" placeholder="ìƒˆë¡œìš´ êµìœ¡ ì£¼ì œ ì…ë ¥" style="padding:5px; width:250px;">
            <button onclick="addTopic()" style="padding:5px 10px; cursor:pointer;">ì¶”ê°€</button>
        </div>
        <div id="topicList" class="topic-list"></div>
    </div>

    <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
        <a href="/download_excel"><button class="btn-download">ğŸ“¥ ì „ì²´ ì¼ì • ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button></a>
    </div>

    <div id='calendar'></div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h3>ì¼ì • ìˆ˜ì • / ì‚­ì œ</h3>
        <input type="hidden" id="edit-id">
        <div class="form-group"><label>êµìœ¡ ì£¼ì œ</label><select id="edit-topic"></select></div>
        <div class="form-group"><label>ê¸°ê´€(ë£¨í‚¤ì„¼í„°) ëª…</label><input type="text" id="edit-center"></div>
        <div class="form-group" style="display:flex; gap:10px;">
            <div style="flex:1;"><label>ì‹œì‘ ì‹œê°„</label><input type="time" id="edit-start-time"></div>
            <div style="flex:1;"><label>ë§ˆì¹¨ ì‹œê°„</label><input type="time" id="edit-end-time"></div>
        </div>
        <div class="form-group"><label>ì‹ ì²­ì ì„±ëª…</label><input type="text" id="edit-applicant"></div>
        <div class="form-group"><label>ì—°ë½ì²˜</label><input type="text" id="edit-contact"></div>
        <button class="btn-update" onclick="updateSchedule()">ìˆ˜ì • ë‚´ìš© ì €ì¥</button>
        <button class="btn-delete" onclick="deleteSchedule()">ì¼ì • ì‚­ì œ</button>
    </div>
</div>

<script>
    const regions = [
        { code: 'gangbuk', name: 'ê°•ë¶', manager: 'ê¹€í˜„ì§„' },
        { code: 'gangnam', name: 'ê°•ë‚¨', manager: 'ì„ì€í˜¸' },
        { code: 'gyeongin', name: 'ê²½ì¸', manager: 'ìœ¤ì„±ì¤€' },
        { code: 'busan', name: 'ë¶€ì‚°', manager: 'ì¡°í˜œë¦°' },
        { code: 'jungbu', name: 'ì¤‘ë¶€', manager: 'ìµœì¥ë¯¼' },
        { code: 'daegu', name: 'ëŒ€êµ¬', manager: 'ê¹€ì¤„ê¸°' },
        { code: 'honam', name: 'í˜¸ë‚¨', manager: 'ê¹€ê²½ë³´' }
    ];

    let calendar;
    let currentRegionCode = null;
    let selectedEventDate = null;

    document.addEventListener('DOMContentLoaded', function() {
        const nav = document.getElementById('region-nav');
        regions.forEach(r => {
            const btn = document.createElement('button');
            btn.className = 'region-btn';
            btn.innerText = r.name;
            btn.onclick = () => loadRegion(r, btn);
            nav.appendChild(btn);
        });
        initCalendar();
    });

    function loadRegion(region, btnElement) {
        currentRegionCode = region.code;
        document.getElementById('current-info').innerText = `${region.name} (${region.manager}) ê´€ë¦¬ ì¤‘`;
        document.querySelectorAll('.region-btn').forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');
        
        loadTopics();
        document.getElementById('topicManager').style.display = 'block';
        calendar.refetchEvents();
    }

    function loadTopics() { if (!currentRegionCode) return; fetch(`/api/topics?region=${currentRegionCode}`).then(res=>res.json()).then(data=>{const list=document.getElementById('topicList');list.innerHTML='';data.forEach(t=>{const item=document.createElement('div');item.className='topic-item';item.draggable=true;item.dataset.id=t.id;item.innerHTML=`<div class="topic-content"><span class="drag-handle">â˜°</span><span>${t.title}</span></div><span class="btn-del-topic" onclick="deleteTopic(${t.id})">&times;</span>`;addDragEvents(item);list.appendChild(item);});});}
    function addDragEvents(item){const list=document.getElementById('topicList');item.addEventListener('dragstart',()=>{item.classList.add('dragging')});item.addEventListener('dragend',()=>{item.classList.remove('dragging');saveOrder()});list.addEventListener('dragover',(e)=>{e.preventDefault();const after=getDragAfterElement(list,e.clientY);const drag=document.querySelector('.dragging');if(after==null)list.appendChild(drag);else list.insertBefore(drag,after)});}
    function getDragAfterElement(c,y){const els=[...c.querySelectorAll('.topic-item:not(.dragging)')];return els.reduce((closest,child)=>{const box=child.getBoundingClientRect();const offset=y-box.top-box.height/2;if(offset<0&&offset>closest.offset)return{offset:offset,element:child};else return closest},{offset:Number.NEGATIVE_INFINITY}).element}
    function saveOrder(){const items=document.querySelectorAll('.topic-item');const ids=Array.from(items).map(i=>i.dataset.id);fetch('/api/topic/reorder',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ids:ids})})}
    function addTopic(){const t=document.getElementById('newTopicTitle').value;if(!t)return;fetch('/api/topic/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({region:currentRegionCode,title:t})}).then(res=>res.json()).then(()=>{document.getElementById('newTopicTitle').value='';loadTopics()})}
    function deleteTopic(id){if(!confirm("ì‚­ì œ?"))return;fetch('/api/topic/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:id})}).then(()=>loadTopics())}

    function initCalendar() {
        var calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ko',
            height: 'auto',
            selectable: true,
            headerToolbar: { left: 'today', center: 'prev title next', right: '' },
            buttonText: { prev: '<', next: '>' },
            
            events: function(info, successCallback) {
                if (!currentRegionCode) { successCallback([]); return; }
                fetch('/api/events').then(res=>res.json()).then(events=>{
                    const filtered = events.filter(e => {
                        if(e.extendedProps.type === 'holiday') {
                            return e.extendedProps.region === 'all' || e.extendedProps.region === currentRegionCode;
                        }
                        return e.extendedProps.region === currentRegionCode;
                    });
                    successCallback(filtered);
                });
            },

            // íœ´ì¼ ì¶”ê°€ (ì¼ê´„ ì ìš© ê¸°ëŠ¥ í¬í•¨)
            select: function(info) {
                if(!currentRegionCode) { alert("ê¶Œì—­ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”."); return; }
                
                const title = prompt(`[${info.startStr}] íœ´ë¬´/ëŒ€ì²´íœ´ì¼ ì‚¬ìœ  ì…ë ¥:`);
                if(title) {
                    const isGlobal = confirm(`"${title}" ì¼ì •ì„ ëª¨ë“  ê¶Œì—­ì— ì¼ê´„ ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n[í™•ì¸] : 7ê°œ ì „ ê¶Œì—­ ì¼ê´„ ì ìš©\n[ì·¨ì†Œ] : í˜„ì¬(${currentRegionCode}) ê¶Œì—­ë§Œ ì ìš©`);
                    const regionVal = isGlobal ? 'all' : currentRegionCode;

                    fetch('/api/add_holiday', {
                        method: 'POST', headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({title:title, start:info.startStr, region:regionVal})
                    }).then(res=>res.json()).then(()=>{
                        alert(isGlobal ? "ì „ì²´ ê¶Œì—­ ì ìš© ì™„ë£Œ" : "í˜„ì¬ ê¶Œì—­ ì ìš© ì™„ë£Œ");
                        calendar.refetchEvents();
                    });
                }
                calendar.unselect();
            },

            // [ìˆ˜ì •ëœ ë¶€ë¶„] ì´ë²¤íŠ¸ í´ë¦­ í•¸ë“¤ëŸ¬
            eventClick: function(info) {
                const props = info.event.extendedProps;
                
                // 1. íœ´ì¼ í´ë¦­ ì‹œ ì‚­ì œ (ì·¨ì†Œ) ë¡œì§
                if(props.type === 'holiday') {
                    // ì‚­ì œ í™•ì¸ ë©”ì‹œì§€
                    const msg = `[íœ´ì¼ ì·¨ì†Œ]\n\n'${info.event.title}'\n\nì´ íœ´ì¼ì„ ì •ë§ ì‚­ì œ(ì·¨ì†Œ)í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
                    
                    if(confirm(msg)) {
                        fetch('/api/delete', {
                            method: 'POST', 
                            headers: {'Content-Type':'application/json'},
                            body: JSON.stringify({
                                id: info.event.id, 
                                type: 'holiday' // íƒ€ì…ì„ ëª…ì‹œí•´ì„œ ì„œë²„ê°€ íœ´ì¼ í…Œì´ë¸”ì—ì„œ ì‚­ì œí•˜ë„ë¡ í•¨
                            })
                        }).then(res => res.json()).then(data => {
                            if(data.status === 'success') {
                                alert("íœ´ì¼ì´ ì‚­ì œ(ì·¨ì†Œ)ë˜ì—ˆìŠµë‹ˆë‹¤.");
                                calendar.refetchEvents();
                            } else {
                                alert("ì‚­ì œ ì‹¤íŒ¨: " + data.message);
                            }
                        });
                    }
                    return; // íœ´ì¼ì¸ ê²½ìš° ì•„ë˜ì˜ ì¼ë°˜ ìˆ˜ì • ëª¨ë‹¬ì„ ì—´ì§€ ì•ŠìŒ
                }

                // 2. ì¼ë°˜ ì¼ì • í´ë¦­ ì‹œ ìˆ˜ì • ëª¨ë‹¬ ì˜¤í”ˆ
                openEditModal(info.event);
            }
        });
        calendar.render();
    }

    function openEditModal(event) {
        const props = event.extendedProps;
        selectedEventDate = event.startStr.split('T')[0];
        document.getElementById('edit-id').value = event.id;
        document.getElementById('edit-center').value = props.center;
        document.getElementById('edit-applicant').value = props.applicant;
        document.getElementById('edit-contact').value = props.contact;
        const startT = event.start.toTimeString().substring(0,5);
        const endT = event.end.toTimeString().substring(0,5);
        document.getElementById('edit-start-time').value = startT;
        document.getElementById('edit-end-time').value = endT;
        const topicSelect = document.getElementById('edit-topic'); topicSelect.innerHTML = '';
        fetch(`/api/topics?region=${currentRegionCode}`).then(res=>res.json()).then(data=>{data.forEach(t=>{const opt=document.createElement('option');opt.value=t.title;opt.innerText=t.title;if(t.title===props.topic)opt.selected=true;topicSelect.appendChild(opt);});});
        document.getElementById('editModal').style.display = 'block';
    }
    function closeEditModal() { document.getElementById('editModal').style.display = 'none'; }
    function updateSchedule() {
        const id=document.getElementById('edit-id').value; const topic=document.getElementById('edit-topic').value; const center=document.getElementById('edit-center').value; const applicant=document.getElementById('edit-applicant').value; const contact=document.getElementById('edit-contact').value; const startT=document.getElementById('edit-start-time').value; const endT=document.getElementById('edit-end-time').value;
        if(startT>=endT){alert("ì‹œê°„ ì˜¤ë¥˜");return;}
        fetch('/api/edit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:id,topic:topic,center:center,applicant:applicant,contact:contact,start:`${selectedEventDate}T${startT}`,end:`${selectedEventDate}T${endT}`})}).then(res=>res.json()).then(data=>{if(data.status==='success'){alert("ìˆ˜ì • ì™„ë£Œ");closeEditModal();calendar.refetchEvents();}else{alert(data.message);}});
    }
    function deleteSchedule() {
        const id=document.getElementById('edit-id').value; if(!confirm("ì‚­ì œ?"))return;
        fetch('/api/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:id,pwd:'admin1234'})}).then(res=>res.json()).then(data=>{alert("ì‚­ì œ ì™„ë£Œ");closeEditModal();calendar.refetchEvents();});
    }
</script>
</body>
</html>